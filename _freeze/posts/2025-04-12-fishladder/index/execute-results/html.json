{
  "hash": "af0747306ce5862af705f71cca2d399d",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Forecasting Salmon Runs: A Time Series Analysis of Willamette Falls Fish Ladder Data\"\nauthor: \"Zoe Zhou\"\ndate: 03-18-2025\nimage: preview.jpg\ncategories: [R, Modeling, Quarto]\nformat: \n  html:\n    code-fold: true\n    embed-resources: true\n    toc: true\nexecute:\n  warning: false\n  message: false\ntheme: minty\n---\n\n\n\n![Willamette River Fish Bypass, Image by dannymoore from Pixabay](https://www.renewableenergyworld.com/wp-content/uploads/2025/01/salmon-1107404_1920.jpg)\n\n### Overview\n\nThe goal of this analysis is to visualize time series data of fish passage at the Willamette Falls fish ladder to identify trends, seasonal patterns, and annual variations in fish passage. Additionally, the analysis includes forecasting using the Holt-Winters method to predict future trends in salmon runs, providing critical information for watershed management and fish recovery efforts.  \n\n#### Background\nFish passage at Willamette Falls is critical for the survival of Oregon’s wild salmon and steelhead, which are on the brink of extinction due to dams blocking access to spawning habitats and degrading river ecosystems. With populations at just 1–2% of their historic levels, this analysis helps uncover migration trends and forecast future passage, providing valuable insights to guide recovery efforts, improve watershed management, and ensure these iconic species are protected for future generations.\n\n#### Data Summary\n\nThis project explores adult fish passage data recorded at the Willamette Falls fish ladder on the Willamett River, Oregon from 2001 to 2010. The dataset provides valuable insights into the migration patterns of five salmon species: Chinook, Jack Chinook, Steelhead, Coho, and Jack Coho. \n\n**Data Citation**: U.S. Army Corps of Engineers, NWD, et al. *DART Adult Passage Counts Daily for All Species*. Data accessed via [Columbia River DART (Data Access in Real Time)](https://www.cbr.washington.edu/dart/query/adult_proj_sum) on January 25, 2023.\n\n#### Analysis Outline\n\n1. Exploratory Data Analysis\n2. Data Preprocessing\n3. Visualization of Time Series\n4. Visualization of Seasonplots for each species\n5. Plot Annual Totals for Fish Passage\n6. Apply Holt-Winters Forecasting\n7. Summarize Trends and Patterns\n\n### Set Up \nThe following libraries will be used for data manipulation, visualization, and building regression models. \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(here)\nlibrary(lubridate)\nlibrary(tsibble)\nlibrary(feasts)\nlibrary(fable)\nlibrary(kableExtra)\nlibrary(patchwork)\nlibrary(skimr)\n```\n:::\n\n\n\n\nImport data, replace NA values with zero, convert Date column from character to `data` and convert df to tsibble using the `as_tsibble()` function. \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Import data\nfish_df <- read_csv(here(\"posts\",\"2025-04-12-fishladder\",'data', 'willamette_fish_passage.csv')) %>% \n  #replace(is.na(.),0) %>% \n  janitor::clean_names()\n\n# Convert to ts\nfish_ts <- fish_df %>% \n  mutate(date = mdy(date)) %>% \n  as_tsibble(key = NULL,\n             index = date) %>% \n  replace(is.na(.), 0)\n```\n:::\n\n\n\n### Preliminary Data Exploration \nThe original dataset contains multiple empty columns with over 3,000 missing values. Therefore, this study focuses on three salmon species—Coho, Jack Coho, and Steelhead salmon—for further analysis.\n\n<details>\n<summary>Click here to expand summary table</summary>\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nskim(fish_df)\n```\n\n::: {.cell-output-display}\n\nTable: Data summary\n\n|                         |        |\n|:------------------------|:-------|\n|Name                     |fish_df |\n|Number of rows           |3652    |\n|Number of columns        |16      |\n|_______________________  |        |\n|Column type frequency:   |        |\n|character                |2       |\n|logical                  |8       |\n|numeric                  |6       |\n|________________________ |        |\n|Group variables          |None    |\n\n\n**Variable type: character**\n\n|skim_variable | n_missing| complete_rate| min| max| empty| n_unique| whitespace|\n|:-------------|---------:|-------------:|---:|---:|-----:|--------:|----------:|\n|project       |         0|             1|  16|  16|     0|        1|          0|\n|date          |         0|             1|   6|   8|     0|     3652|          0|\n\n\n**Variable type: logical**\n\n|skim_variable  | n_missing| complete_rate| mean|count |\n|:--------------|---------:|-------------:|----:|:-----|\n|chinook_run    |      3652|             0|  NaN|:     |\n|wild_steelhead |      3652|             0|  NaN|:     |\n|sockeye        |      3652|             0|  NaN|:     |\n|shad           |      3652|             0|  NaN|:     |\n|lamprey        |      3652|             0|  NaN|:     |\n|bull_trout     |      3652|             0|  NaN|:     |\n|chum           |      3652|             0|  NaN|:     |\n|pink           |      3652|             0|  NaN|:     |\n\n\n**Variable type: numeric**\n\n|skim_variable | n_missing| complete_rate|   mean|     sd|   p0|  p25|  p50|    p75|   p100|hist  |\n|:-------------|---------:|-------------:|------:|------:|----:|----:|----:|------:|------:|:-----|\n|chinook       |      1543|          0.58| 250.48| 476.52|  1.0| 7.00| 35.0| 236.00| 3883.0|▇▁▁▁▁ |\n|jack_chinook  |      2433|          0.33|  11.22|  16.37|  1.0| 2.00|  6.0|  14.00|  170.0|▇▁▁▁▁ |\n|steelhead     |       203|          0.94|  85.97| 115.68| -2.0| 8.00| 28.0| 127.00|  709.0|▇▂▁▁▁ |\n|coho          |      2694|          0.26|  76.03| 160.84| -2.0| 3.25| 15.0|  57.75| 1290.0|▇▁▁▁▁ |\n|jack_coho     |      2971|          0.19|  21.03|  37.02|  1.0| 2.00|  7.0|  22.00|  380.0|▇▁▁▁▁ |\n|temp_c        |      1382|          0.62|  12.94|   6.04|  0.6| 7.80| 11.7|  17.80|   26.7|▂▇▆▃▃ |\n\n\n:::\n:::\n\n\n\n</details>\n\n#### Decomposition Summary\n\nTo better understand the structure of time series data, it's useful to decompose to separately explore contributions of the different components (trend, seasonality, etc). This study employs **Seasonal and Trend Decomposition using LOESS** (Locally Estimated Scatterplot Smoothing), a method for estimating nonlinear relationships. It applies a weighted moving average across all points in the dataset, with weights determined by their distance from the point being averaged. `STL()` function from the `feasts` is used to obtain decomposition.\n\n<details>\n<summary>Click here to expand decomposition plots</summary>\n\n:::{.panel-tabset}\n\n## Jack Coho\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Prepare data for plotting\nfish_long <- fish_ts %>% \n  select('date', 'steelhead','coho', 'jack_coho') %>% \n  pivot_longer(\n    cols = -date,\n    names_to = \"species\",\n    values_to = \"counts\"\n  )\n\n# Obtain decomposition\njack_dcmp <- fish_long %>% \n  filter(species =='jack_coho') %>% \n  model(STL(counts~season(period = \"1 year\") + trend(window = 25)))\n\n# Visualize components\ncomponents(jack_dcmp) %>% \n  autoplot()+\n  theme_classic()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n\n\n## Coho Salmon\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Obtain decomposition\ncoho_dcmp <- fish_long %>% \n  filter(species =='coho') %>% \n  model(STL(counts~season(period = \"1 year\") + trend(window = 25)))\n\n# Visualize components\ncomponents(coho_dcmp) %>% \n  autoplot()+\n  theme_classic()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n\n\n## Steelhead\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Obtain decomposition\njack_dcmp <- fish_long %>% \n  filter(species =='steelhead') %>% \n  model(STL(counts~season(period = \"1 year\") + trend(window = 25)))\n\n# Visualize components\ncomponents(jack_dcmp) %>% \n  autoplot()+\n  theme_classic()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\n\n:::\n</details>\n### Data Visualization\n:::{.panel-tabset}\n## Daily Time Series Plot \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create plot\nggplot(fish_long, aes(x=date, y=counts, color=species)) +\n  geom_line() +\n  labs(title = \"Time Series Plots of Salmon Adult Passage\",\n       x = \"Time\",\n       y = \"Counts\") +\n  scale_color_brewer(palette = \"Set2\")+\n  theme_minimal()+\n  facet_wrap(~species,ncol=1)+\n  theme(legend.position='none')\n```\n\n::: {.cell-output-display}\n![Figure 1: Time Series of Adult Passage for Coho, Jack Coho, and Steelhead salmon.](index_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\nFrom the time series plots in Figure 1, we can observe the following observations:\n\n- Steelhead consistently has higher counts compare to Coho and Jack Coho salmon. There is relatively low abundance of Jack Coho salmon, with smaller and less frequent peaks compared to the other species.\n- All three species exhibit seasonal peaks in their counts. Steelhead salmon displays broader and more frequent peaks over time, suggesting a longer migration period.\n- There is increasing trend in the counts of Coho salmon after 2008, with higher peaks observed in subsequent years.\n\n## Seasonplots\nA seasonplot can help point out seasonal patterns, and help to glean insights over the years. We'll use `feasts::gg_season()` to create an exploratory seasonplot, which has month on the x-axis, salmon counts on the y-axis, and each year is its own series (mapped by line color).\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfish_long %>% \n  gg_season(y=counts, pal=hcl.colors(n=10)) + \n  theme_light()+\n  labs(title='Seasonplots of Daily Counts for Salmon Passage by Species',\n    x=\"month\",\n       y=\"Species Counts\")\n```\n\n::: {.cell-output-display}\n![Figure 2: Seasonplots of Daily Counts for Salmon Passage by Species](index_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n\nFigure 2 displays the seasonal variation in the counts of salmon species across all years, with each line representing a specific year and highlighting recurring monthly patterns. Since the daily counts were too stochastic and busy, especially for steelhead salmon, I opted to use monthly means for clearer interpretation. \n\nSeasonplots with monthly total:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfish_month <- fish_long %>% \n  index_by(yr_mo = ~yearmonth(.)) %>% \n  group_by(year = year(yr_mo), month = month(yr_mo, label=TRUE), species) %>% \n  summarize(month_total = sum(counts, na.rm=TRUE), month_mean = mean(counts, na.rm=TRUE), .groups = \"drop\") %>% \n  ungroup()\n\nfish_month %>%\n  mutate(year = factor(year)) %>%\n  ggplot(aes(x = month, y = month_total, colour = year, group = year)) +\n  geom_line() + # Draw lines connecting points for each year\n  # ggplot will automatically use a discrete scale because 'year' is a factor\n  theme_light() +\n  labs(\n    title = 'Monthly Total Counts for Salmon Passage by Species', # Adjusted title\n    x = \"Month\",\n    y = \"Species Counts\",\n    colour = \"Year\" # Legend title\n  ) +\n  facet_wrap(~species, ncol = 1, scales = \"free_y\") # Facet by species\n```\n\n::: {.cell-output-display}\n![Figure 3: Seasonplots of Monthly Total Counts for Salmon Passage by Species](index_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n\n\nFigure 2 and 3 shows the monthly variation in counts for three salmon species across multiple years:\n\n- Both Coho and Jack Coho salmon show a sharp and well-defined seasonal peak in September, with Coho consistently having significantly higher peak counts compared to Jack Coho, as also seen in the original time series.\n- Steelhead salmon exhibit a broader seasonal pattern, with counts steadily increasing from January to a peak in May or June, followed by a rapid decline, suggesting a longer migration period.\n- Interannual variability is noticeable, particularly in Coho, where a sharper increase in counts is observed in later years.\n\n## Annual Counts\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Prep data for plotting\nfish_yr <- fish_long %>% \n  index_by(year = ~year(.)) %>%\n  group_by(species) %>% \n  summarize(annual_total = sum(counts)) %>% \n  ungroup()\n# Convert year column to factor\nfish_yr$year = as.factor(fish_yr$year)\n\nfish_yr %>%\n  ggplot(aes(x = year, y = annual_total, color = species, group = species)) +  # Explicitly group by species\n  geom_line() +\n  theme_minimal() +\n  labs(\n    title = \"Annual Total Counts of Fish Passage by Species\",\n    x = \"Year\",\n    y = \"Counts\"\n  ) +\n  scale_color_brewer(palette = 'Set2')\n```\n\n::: {.cell-output-display}\n![Figure 4: Plot of Annual Counts of Fish Passage by Species](index_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n\n- Annual Steelhead counts show significant interannual variability, with drop of 25000 counts between 2002 and 2003. \n- Jack Coho salmon consistently has the lowest counts among the three species, with minimal variation over the years. \n- Coho counts remain relatively low until 2008, after which there's a sharp increas, reaching a significant peak with annual counts over 25,000 in 2010.\n\n## Forecast\nWe use the `ETS()` function from the `fable` package to generate predictions. Exponential smoothing calculates weighted averages of past observations, with the weights decreasing exponentially as the observations become older. Given the change in variance over time, we specify **multiplicative seasonality**, and set `restrict` as `FALSE` to allow function to find best model.\n\nThe results show negative counts for Steelhead and Jack Coho salmon, which is unrealistic and indicates that this forecasting method is not suitable for salmon data.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsalmon_ts <- fish_ts %>% select(date, coho, jack_coho, steelhead)\n\n# Reshape the data into a long format\nsalmon_long <- salmon_ts %>%\n  pivot_longer(cols = c(coho, jack_coho, steelhead), \n               names_to = \"species\", \n               values_to = \"counts\")\n\n# Fit the ETS model for each species\n\nets_models <- salmon_long %>%\n  model(ets = ETS(counts~season(\"M\"), restrict=FALSE))\n\n# Generate forecasts for each species \nforecasts <- ets_models %>%\n  forecast(h = \"5 years\")\n\n# Plot the forecasts along with historical data\nforecasts %>%\n  autoplot(salmon_long, level = NULL) +\n  labs(\n    title = \"Historical and Forecasted Salmon Passage by Species\",\n    y = \"Counts\",\n    x = \"Date\"\n  ) +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nkable(ets_models, col.names=c(\"Species\",\"ETS Model(Error, Trend, Seasonality)\"), caption = \"ETS Models by Species\")\n```\n\n::: {.cell-output-display}\n\n\nTable: ETS Models by Species\n\n|Species   |ETS Model(Error, Trend, Seasonality) |\n|:---------|:------------------------------------|\n|coho      |<NULL model>                         |\n|jack_coho |<ETS(A,N,M)>                         |\n|steelhead |<ETS(A,N,M)>                         |\n\n\n:::\n:::\n\n\n\n\n\nThe differences in the ETS models arise because the `ETS()` function automatically selects the best model based on the data for each species. For Jack Coho and Steelhead, the data likely exhibited clear seasonal patterns with varying magnitudes, leading to the selection of a model with multiplicative seasonality. In contrast, Coho data may not show significant seasonal or trend components, so no model were selected.\n:::\n\n### Summary\n\nForecast results suggest that forcing a seasonal model may not be appropriate. Further exploration is needed to find the correct model for forecasting. Here we use a autocorrelation function to confirm our interpretation. \n\nAutocorrelation function (ACF) shows how correlated observations within a series are with pervious observations on the same variable. In the context of salmon passage, the ACF helps identify patterns in the monthly average counts of steelhead salmon passing through the ladder over time. This analysis is useful for guiding selection of models to forecast future values in a time series.\n\n<details>\n<summary>Click here to expand ACF plots</summary>\n:::{.panel-tabset}\n## Steelhead\nFor Steelhead salmon, I do not expect exponential smoothing (ETS) to be the most effective forecasting method due to its broader and more variable seasonal pattern and significant interannual variability. \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# autocorrelation for steelhead\nfish_bymonth <- fish_long %>% \n  index_by(yr_mo = ~yearmonth(.)) %>% \n  group_by(species) %>% \n  summarize(month_total = sum(counts, na.rm=TRUE)) %>% \n  ungroup()\n\nfish_bymonth %>% \n  filter(species == 'steelhead') %>% \n  ACF(month_total) %>% \n  autoplot() +\n  theme_minimal()+\n  labs(\n    title=\"ACF plot for Steelhead Salmon Passage\",\n    x=\"lag (in month)\",\n    y=\"autocorrelation coefficient\"\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n\n\n## Coho \nFor Coho salmon, I do not expect exponential smoothing (ETS) to be the most effective forecasting method due to its broader and more variable seasonal pattern and significant interannual variability. \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# autocorrelation for coho\nfish_bymonth %>% \n  filter(species == 'coho') %>% \n  ACF(month_total) %>% \n  autoplot() +\n  theme_minimal()+\n  labs(\n    title=\"ACF plot for Coho Salmon Passage\",\n    x=\"lag (in month)\",\n    y=\"autocorrelation coefficient\"\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n\n\n\n## Jack Coho\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# autocorrelation for jack coho\nfish_bymonth %>% \n  filter(species == 'jack_coho') %>% \n  ACF(month_total) %>% \n  autoplot() +\n  theme_minimal()+\n  labs(\n    title=\"ACF plot for Jack Coho Salmon Passage\",\n    x=\"lag (in month)\",\n    y=\"autocorrelation coefficient\"\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\n\n\n\nFor **Jack Coho salmon**, the highest correlation coefficient occurs at lags of **12 months**, indicating seasonality. This suggests that **exponential smoothing** could be a suitable forecasting method. \n\n:::\n</details>\n\n\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}